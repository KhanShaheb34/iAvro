name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest
    env:
      APP_NAME: Avro Silicon
      DERIVED_DATA_PATH: build/DerivedData
      DIST_PATH: build/dist
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Xcode Version
        run: xcodebuild -version

      - name: Run Regression Fixtures
        run: scripts/run_regression_tests.sh

      - name: Build Release App
        run: |
          xcodebuild \
            -project AvroKeyboard.xcodeproj \
            -scheme "Avro Silicon" \
            -configuration Release \
            -sdk macosx \
            -derivedDataPath "$DERIVED_DATA_PATH" \
            CODE_SIGNING_ALLOWED=NO \
            build

      - name: Package Release Artifact
        run: |
          set -euo pipefail

          APP_PATH="$DERIVED_DATA_PATH/Build/Products/Release/$APP_NAME.app"
          if [[ ! -d "$APP_PATH" ]]; then
            echo "App bundle not found at: $APP_PATH" >&2
            exit 1
          fi

          mkdir -p "$DIST_PATH"

          ARCHIVE_NAME="Avro-Silicon-${GITHUB_REF_NAME}.tar.gz"
          ARCHIVE_PATH="$DIST_PATH/$ARCHIVE_NAME"

          tar -czf "$ARCHIVE_PATH" -C "$(dirname "$APP_PATH")" "$(basename "$APP_PATH")"
          shasum -a 256 "$ARCHIVE_PATH" > "$ARCHIVE_PATH.sha256"

          echo "ARCHIVE_PATH=$ARCHIVE_PATH" >> "$GITHUB_ENV"

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: avro-silicon-${{ github.ref_name }}
          path: |
            build/dist/*.tar.gz
            build/dist/*.sha256

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            build/dist/*.tar.gz
            build/dist/*.sha256
